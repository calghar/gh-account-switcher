# Advanced Features

This guide covers advanced features and customization options for power users.

## Directory-Based Profile Switching

### Automatic Profile Detection

The most powerful feature is automatic profile switching based on your current directory. This eliminates the need to manually switch profiles when working on different projects.

#### How It Works

1. **Rule Matching**: When you run `gh-switch` without arguments in a git repository, it checks for directory rules
2. **Path Resolution**: Rules are matched against the current working directory using absolute paths
3. **Longest Match**: If multiple rules match, the longest (most specific) path wins
4. **Silent Switching**: Auto-switching is performed silently unless there's an error

#### Advanced Rule Management

```bash
# Set up hierarchical rules
gh-switch auto /home/user/projects work           # Default for all projects
gh-switch auto /home/user/projects/personal personal  # Override for personal
gh-switch auto /home/user/projects/client-a client-a  # Specific client

# The most specific rule wins:
# /home/user/projects/personal/my-app -> personal profile
# /home/user/projects/client-a/project -> client-a profile  
# /home/user/projects/work-stuff -> work profile
```

#### Integration with Shell

Add to your shell profile for seamless integration:

```bash
# Add to ~/.bashrc, ~/.zshrc, etc.
cd() {
  builtin cd "$@" && {
    if command -v gh-switch >/dev/null 2>&1 && git rev-parse --git-dir >/dev/null 2>&1; then
      gh-switch 2>/dev/null || true
    fi
  }
}
```

This automatically checks for profile switches every time you change directories.

## Advanced Profile Management

### Bulk Profile Operations

#### Template-Based Profile Creation

Create a template file for common setups:

```json
{
  "work-template": {
    "emails": ["${USERNAME}@company.com"],
    "primary_email": "${USERNAME}@company.com",
    "name": "${FULL_NAME}",
    "gpg_key": "${GPG_KEY}"
  }
}
```

Then use environment variables for customization:

```bash
# Set variables
export USERNAME="john.doe"
export FULL_NAME="John Doe"
export GPG_KEY="ABC123DEF456"

# Process template and import
envsubst < work-template.json | gh-switch import /dev/stdin
```

#### Batch Email Management

```bash
# Add multiple emails to a profile
emails=("john@company.com" "j.doe@company.com" "john.doe@contractor.com")
for email in "${emails[@]}"; do
  gh-switch add-email work "$email"
done

# Export profile, modify, and re-import
gh-switch export > profiles.json
# Edit profiles.json manually
gh-switch import profiles.json
```

## Git Hooks Integration

### Pre-commit Profile Validation

Create a git hook to ensure you're using the correct profile:

```bash
#!/bin/bash
# .git/hooks/pre-commit

# Get current profile
current_profile=$(gh-switch current 2>/dev/null | grep "Current profile:" | cut -d: -f2 | xargs)
git_email=$(git config user.email)

# Define expected profiles for different directories
case "$(pwd)" in
  */work/*)
    expected_profile="work"
    ;;
  */personal/*)
    expected_profile="personal"
    ;;
  *)
    expected_profile=""
    ;;
esac

if [[ -n "$expected_profile" ]] && [[ "$current_profile" != "$expected_profile" ]]; then
  echo "ERROR: Wrong profile for this directory"
  echo "Current: $current_profile (${git_email})"
  echo "Expected: $expected_profile"
  echo "Run: gh-switch switch $expected_profile"
  exit 1
fi
```

### Post-checkout Profile Switching

Automatically switch profiles when checking out branches:

```bash
#!/bin/bash
# .git/hooks/post-checkout

# Only run on branch checkout, not file checkout
if [[ "$3" == "1" ]]; then
  # Check if gh-switch is available and we have auto-switching rules
  if command -v gh-switch >/dev/null 2>&1; then
    gh-switch 2>/dev/null || true
  fi
fi
```

## Advanced SSH Configuration

### Dynamic SSH Config Generation

Create a script to generate SSH config from gh-switch profiles:

```bash
#!/bin/bash
# generate-ssh-config.sh

cat > ~/.ssh/config << 'EOF'
# Generated by gh-switch - do not edit manually
# Regenerate with: generate-ssh-config.sh

EOF

# Add entries for each profile
gh-switch list | grep -E '^\s*[\*\s]' | sed 's/^[[:space:]\*]*//' | cut -d' ' -f1 | while read -r profile; do
  cat >> ~/.ssh/config << EOF

# Profile: $profile
Host github-$profile
    HostName github.com
    User git
    IdentityFile ~/.ssh/id_$profile
    IdentitiesOnly yes
    AddKeysToAgent yes
EOF

  # Add platform-specific options
  if [[ "$OSTYPE" == "darwin"* ]]; then
    echo "    UseKeychain yes" >> ~/.ssh/config
  fi
done
```

### SSH Key Management Automation

```bash
#!/bin/bash
# setup-ssh-keys.sh

setup_ssh_key() {
  local profile="$1"
  local email="$2"
  
  if [[ ! -f ~/.ssh/id_$profile ]]; then
    echo "Generating SSH key for $profile..."
    ssh-keygen -t ed25519 -C "$email" -f ~/.ssh/id_$profile -N ""
  fi
  
  # Add to SSH agent
  if [[ "$OSTYPE" == "darwin"* ]]; then
    ssh-add --apple-use-keychain ~/.ssh/id_$profile
  else
    ssh-add ~/.ssh/id_$profile
  fi
  
  echo "Public key for $profile:"
  cat ~/.ssh/id_$profile.pub
  echo "Add this key to GitHub account: $email"
}

# Set up keys for all profiles
gh-switch export | jq -r 'to_entries[] | "\(.key) \(.value.primary_email)"' | while read -r profile email; do
  setup_ssh_key "$profile" "$email"
done
```

## Configuration Management

### Centralized Configuration

For teams or multiple machines, store configuration in a central location:

```bash
# ~/.github-switcher/config.sh
export GH_SWITCH_BACKUP_DIR="$HOME/Dropbox/github-switcher-backups"
export GH_SWITCH_AUTO_BACKUP=true
export GH_SWITCH_QUIET=false

# Backup function
backup_profiles() {
  if [[ "$GH_SWITCH_AUTO_BACKUP" == "true" ]]; then
    mkdir -p "$GH_SWITCH_BACKUP_DIR"
    gh-switch export > "$GH_SWITCH_BACKUP_DIR/profiles-$(date +%Y%m%d-%H%M%S).json"
    
    # Keep only last 10 backups
    ls -t "$GH_SWITCH_BACKUP_DIR"/profiles-*.json | tail -n +11 | xargs rm -f
  fi
}

# Source this in your shell profile
if [[ -f ~/.github-switcher/config.sh ]]; then
  source ~/.github-switcher/config.sh
fi
```

### Environment-Specific Profiles

Use different profile sets for different environments:

```bash
# ~/.bashrc or ~/.zshrc
case "$HOSTNAME" in
  work-laptop)
    export GH_SWITCH_PROFILE_SET="work"
    ;;
  personal-desktop)
    export GH_SWITCH_PROFILE_SET="personal"
    ;;
esac

# Load environment-specific profiles
if [[ -n "$GH_SWITCH_PROFILE_SET" ]]; then
  config_file="$HOME/.github-switcher/profiles-$GH_SWITCH_PROFILE_SET.json"
  if [[ -f "$config_file" ]]; then
    gh-switch import "$config_file" 2>/dev/null || true
  fi
fi
```

## Scripting and Automation

### CI/CD Integration

Use gh-switch in CI/CD pipelines:

```yaml
# .github/workflows/multi-account.yml
name: Multi-Account Deployment

on: [push]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Setup gh-switch
        run: |
          curl -o gh-switch https://raw.githubusercontent.com/calghar/gh-account-switcher/main/src/gh-switch-linux.sh
          chmod +x gh-switch
          sudo mv gh-switch /usr/local/bin/
      
      - name: Configure profiles
        run: |
          gh-switch --yes add deploy "${{ secrets.DEPLOY_EMAIL }}" "Deploy Bot" "${{ secrets.GPG_KEY }}"
          gh-switch --yes switch deploy
      
      - name: Deploy
        run: |
          # Your deployment commands here
          git commit -m "Automated deployment"
          git push
```

### Monitoring and Logging

Add logging to track profile usage:

```bash
#!/bin/bash
# ~/.github-switcher/hooks/post-switch.sh

# Called after successful profile switch
log_switch() {
  local profile="$1"
  local email="$2"
  local timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
  local hostname=$(hostname)
  local pwd_info=$(pwd)
  
  # Log to file
  echo "$timestamp,$hostname,$pwd_info,$profile,$email" >> ~/.github-switcher/switch.log
  
  # Optional: Send to logging service
  # curl -X POST "https://your-logging-service.com/api/events" \
  #   -H "Content-Type: application/json" \
  #   -d "{\"timestamp\":\"$timestamp\",\"hostname\":\"$hostname\",\"directory\":\"$pwd_info\",\"profile\":\"$profile\",\"email\":\"$email\"}"
}

log_switch "$@"
```

### Profile Analytics

Analyze profile usage patterns:

```bash
#!/bin/bash
# analyze-usage.sh

if [[ ! -f ~/.github-switcher/switch.log ]]; then
  echo "No usage log found"
  exit 1
fi

echo "Profile Usage Statistics:"
echo "========================"

# Most used profiles
echo "Most used profiles:"
cut -d, -f4 ~/.github-switcher/switch.log | sort | uniq -c | sort -nr | head -5

# Usage by day
echo -e "\nUsage by day (last 7 days):"
for i in {0..6}; do
  date_str=$(date -d "$i days ago" +"%Y-%m-%d")
  count=$(grep "^$date_str" ~/.github-switcher/switch.log | wc -l)
  echo "$date_str: $count switches"
done

# Directory patterns
echo -e "\nTop directories:"
cut -d, -f3 ~/.github-switcher/switch.log | sort | uniq -c | sort -nr | head -10
```

## Custom Extensions

### Plugin System

Create a simple plugin system:

```bash
# ~/.github-switcher/plugins/notify.sh
#!/bin/bash
# Plugin: Desktop notifications for profile switches

notify_switch() {
  local profile="$1"
  local email="$2"
  
  case "$OSTYPE" in
    darwin*)
      osascript -e "display notification \"Switched to $profile ($email)\" with title \"GitHub Account Switcher\""
      ;;
    linux*)
      if command -v notify-send >/dev/null; then
        notify-send "GitHub Account Switcher" "Switched to $profile ($email)"
      fi
      ;;
  esac
}

notify_switch "$@"
```

### Integration with Other Tools

#### VS Code Integration

```json
// .vscode/tasks.json
{
  "version": "1.0.0",
  "tasks": [
    {
      "label": "Switch to Work Profile",
      "type": "shell",
      "command": "gh-switch",
      "args": ["switch", "work"],
      "group": "build",
      "presentation": {
        "echo": true,
        "reveal": "silent",
        "focus": false,
        "panel": "shared"
      }
    }
  ]
}
```

#### iTerm2/Terminal Integration (macOS)

```bash
# Add to ~/.bash_profile or ~/.zshrc
# Show current profile in terminal prompt
export PS1="\u@\h:\w [\$(gh-switch current 2>/dev/null | grep 'Current profile:' | cut -d: -f2 | xargs)]$ "
```

This advanced configuration gives you a powerful, automated system for managing multiple GitHub accounts across different projects and environments.
